<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano SP 2027: Liberdade para o Cidadão que Produz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="icon" href="favicon.png" type="image/x-icon">
    <!-- MathJax para fórmulas profissionais -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .ai-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .source-tag {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        html {
            scroll-behavior: smooth;
        }

        .logic-box {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
    </style>
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>

<body class="antialiased">

    <!-- Navegação -->
    <nav class="bg-white/95 backdrop-blur-md sticky top-0 z-50 shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-car-side text-teal-600 text-2xl mr-3"></i>
                <span class="font-black text-xl text-slate-800 tracking-tighter uppercase">IPVA<span
                        class="text-teal-600">1%</span>SP</span>
            </div>
            <div class="hidden md:flex space-x-6 text-[10px] font-black uppercase tracking-widest text-slate-500">
                <a href="#analise" class="hover:text-teal-600 transition">Análise Financeira</a>
                <a href="#plano" class="hover:text-teal-600 transition">Plano de Viabilidade</a>
                <a href="#deputados" class="hover:text-teal-600 transition">Assembleia</a>
            </div>
        </div>
    </nav>

    <!-- Header / Manifesto de Liberdade -->
    <header class="bg-slate-900 text-white pt-16 pb-32 relative text-center">
        <div class="max-w-7xl mx-auto px-6 relative z-10">
            <div
                class="inline-block bg-teal-500/20 text-teal-400 text-[10px] font-black px-4 py-1.5 rounded-full mb-6 border border-teal-500/30 uppercase tracking-[0.2em]">
                Movimento Apartidário pela Liberdade Econômica
            </div>
            <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight">IPVA 1%: Liberdade para o <br><span
                    class="text-teal-400">Cidadão que Produz.</span></h1>
            <p class="text-lg md:text-xl text-slate-400 max-w-3xl mx-auto leading-relaxed">
                Nosso viés não é político, é a **liberdade das pessoas**. O governo já é sócio de 70% do custo do seu
                veículo. É hora de devolver esse dinheiro para quem realmente trabalha.
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 -mt-20 space-y-12 pb-24 relative z-20">

        <!-- SEÇÃO 1: ANÁLISE DO MARKUP E SIMULADOR INTEGRADO -->
        <section id="analise" class="space-y-8">
            <div class="card border-t-8 border-teal-500">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6 items-start">

                    <!-- Col 1: Calculadora Principal (Inputs) - Span 3 -->
                    <div class="lg:col-span-3 space-y-5">
                        <!-- Valor Veículo -->
                        <div
                            class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm relative group focus-within:ring-2 ring-teal-500/50 transition">
                            <div class="flex items-center justify-between mb-2">
                                <label
                                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest block">Valor
                                    Do Veículo</label>
                                <span
                                    class="bg-teal-100 text-teal-600 text-[9px] font-bold px-2 py-0.5 rounded uppercase">Editável</span>
                            </div>
                            <div class="relative">
                                <span
                                    class="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm"></span>
                                <input type="text" id="priceInput" value="R$ 100.000,00"
                                    class="w-full bg-transparent text-xl font-black text-slate-900 outline-none placeholder-slate-300"
                                    placeholder="R$ 0,00">
                            </div>
                        </div>

                        <!-- Impostos (Configurável) -->
                        <div
                            class="bg-red-50 p-4 rounded-xl border border-red-100 shadow-sm relative group focus-within:ring-2 ring-red-500/50 transition">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-[10px] font-black text-red-400 uppercase tracking-widest block">Carga
                                    Tributária ("Por Dentro")</label>
                                <span
                                    class="bg-red-100 text-red-500 text-[9px] font-bold px-2 py-0.5 rounded uppercase">Editável</span>
                            </div>

                            <div class="grid grid-cols-5 gap-4">
                                <!-- Coluna % (Editavel) -->
                                <div class="col-span-2 border-r border-red-200 pr-2">
                                    <label class="text-[8px] font-bold text-red-300 uppercase block mb-1">Alíquota
                                        %</label>
                                    <input type="text" id="taxPercentInput" value="41,3%"
                                        class="w-full bg-transparent text-xl font-black text-red-600 outline-none placeholder-red-300 text-center"
                                        placeholder="0%">
                                </div>
                                <!-- Coluna Valor (Calculado) -->
                                <div class="col-span-3 pl-2 relative group/taxTooltip">
                                    <div class="flex items-center gap-1 cursor-help">
                                        <label class="text-[8px] font-bold text-red-300 uppercase block mb-1">Valor
                                            Imposto</label>
                                        <i
                                            class="fa-regular fa-circle-question text-[8px] text-red-300 hover:text-red-100 transition mb-1"></i>
                                    </div>
                                    <div class="text-xl font-black text-red-800" id="taxValueDisplay">R$ 41.300,00</div>

                                    <!-- Tooltip Imposto -->
                                    <div
                                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-900 border border-slate-700 text-white text-[10px] rounded-lg p-3 shadow-xl opacity-0 invisible group-hover/taxTooltip:opacity-100 group-hover/taxTooltip:visible transition-all z-20 pointer-events-none text-left">
                                        <div
                                            class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-900 rotate-45 border-b border-r border-slate-700">
                                        </div>
                                        <p class="leading-relaxed font-medium">
                                            <strong class="text-teal-400 block mb-1">Para onde vai?</strong>
                                            É o dinheiro que você paga mas não leva. Vai para o governo (IPI, ICMS,
                                            PIS/COFINS). <br><br>
                                            No Brasil, quase metade do valor do carro é só taxa.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resultados Derivados -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-slate-100 rounded-xl border border-slate-200 relative group/costTooltip">
                                <div class="flex items-center gap-1 cursor-help">
                                    <span class="block text-[8px] font-black text-slate-400 uppercase">Custo Real
                                        (Fábrica)</span>
                                    <i
                                        class="fa-regular fa-circle-question text-[8px] text-slate-400 hover:text-slate-600 transition"></i>
                                </div>
                                <span class="text-sm font-bold text-slate-700 block mt-1" id="costAmount">R$
                                    58.700,00</span>

                                <!-- Tooltip Custo -->
                                <div
                                    class="absolute bottom-full left-0 mb-2 w-48 bg-slate-900 border border-slate-700 text-white text-[10px] rounded-lg p-3 shadow-xl opacity-0 invisible group-hover/costTooltip:opacity-100 group-hover/costTooltip:visible transition-all z-20 pointer-events-none text-left">
                                    <div
                                        class="absolute -bottom-1 left-4 w-2 h-2 bg-slate-900 rotate-45 border-b border-r border-slate-700">
                                    </div>
                                    <p class="leading-relaxed font-medium">
                                        <strong class="text-teal-400 block mb-1">O que isso cobre?</strong>
                                        É o valor real do produto: materiais, peças, salário dos funcionários,
                                        desenvolvimento e o lucro da fábrica. <br><br>
                                        Sem impostos, esse seria o preço do carro.
                                    </p>
                                </div>
                            </div>
                            <div
                                class="p-3 bg-red-100 rounded-xl border border-red-200 text-center relative group/tooltip">
                                <div class="flex items-center justify-center gap-1.5 cursor-help">
                                    <span class="block text-[8px] text-red-800 font-black uppercase">Markup (Por
                                        Fora)</span>
                                    <i
                                        class="fa-regular fa-circle-question text-[10px] text-red-400 hover:text-red-600 transition"></i>
                                </div>
                                <div class="text-lg font-black text-red-600 mt-1" id="markupPercent">70,36%</div>

                                <!-- Tooltip -->
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-900 border border-slate-700 text-white text-[10px] rounded-lg p-3 shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all z-20 pointer-events-none text-left">
                                    <div
                                        class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-900 rotate-45 border-b border-r border-slate-700">
                                    </div>
                                    <p class="leading-relaxed font-medium">
                                        <strong class="text-teal-400 block mb-1">O que é isso?</strong>
                                        É o quanto o governo cobra "em cima" do custo real. <br><br>
                                        Ex: Se o markup for <strong>100%</strong>, significa que para cada <strong>R$
                                            1,00</strong> que vale o carro, você paga mais <strong>R$ 1,00</strong> só
                                        de impostos.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Col 2: Gráfico - Span 3 -->
                    <div
                        class="lg:col-span-3 flex flex-col justify-center h-full min-h-[250px] bg-white rounded-2xl border border-slate-100 p-4 shadow-sm relative">
                        <div class="absolute top-4 left-0 right-0 text-center">
                            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Carga na Compra
                            </h2>
                        </div>
                        <div class="chart-container mt-4">
                            <canvas id="markupChart"></canvas>
                        </div>
                    </div>

                    <!-- Col 3: Simulação Longo Prazo (Novo) - Span 3 -->
                    <div
                        class="lg:col-span-3 bg-slate-900 text-white rounded-2xl p-5 shadow-xl flex flex-col h-full relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-teal-500 blur-[50px] opacity-20"></div>

                        <h3
                            class="text-[10px] font-black text-teal-400 uppercase mb-4 tracking-widest border-b border-white/10 pb-2">
                            Simulação de Posse
                        </h3>

                        <div class="mb-6 relative">
                            <label class="text-[9px] font-bold text-slate-400 uppercase block mb-2">Tempo com o Veículo
                                (Anos)</label>
                            <div class="flex items-center gap-3">
                                <button onclick="adjustYears(-1)"
                                    class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition font-bold">-</button>
                                <input type="number" id="yearsInput" value="5" min="1" max="30"
                                    class="w-16 bg-transparent text-center text-2xl font-black text-white outline-none border-b-2 border-teal-500 focus:border-teal-400 transition"
                                    oninput="updateCalculations()">
                                <button onclick="adjustYears(1)"
                                    class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition font-bold">+</button>
                            </div>
                        </div>

                        <div class="mt-auto space-y-3">
                            <div>
                                <span class="text-[9px] text-slate-400 uppercase font-bold block">Total Pago ao Governo
                                    (Hoje)</span>
                                <div class="text-2xl font-black text-red-400" id="totalTaxCurrent">R$ 61.300,00</div>
                                <span class="text-[9px] text-slate-500 italic block leading-tight mt-1">Imposto Compra +
                                    (IPVA 4% x Anos)</span>
                            </div>
                            <div class="pt-3 border-t border-white/10">
                                <span class="text-[9px] text-teal-400 uppercase font-bold block">Com IPVA 1%
                                    (Proposto)</span>
                                <div class="text-xl font-bold text-white" id="totalTaxProposed">R$ 46.300,00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Col 4: Comparativo IPVA - Span 3 -->
                    <div
                        class="lg:col-span-3 bg-slate-50 rounded-2xl p-4 border border-slate-200 flex flex-col justify-between h-full">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest text-center">
                            Economia Anual</h2>
                        <div class="space-y-3">
                            <div class="p-3 bg-white rounded-xl border border-slate-200 text-center opacity-60">
                                <span class="text-[8px] font-bold text-slate-400 uppercase">IPVA 4% (Hoje)</span>
                                <div class="text-xl font-black text-slate-400 line-through" id="ipvaCurrent">R$ 4.000,00
                                </div>
                            </div>
                            <div class="p-3 bg-teal-600 rounded-xl text-center shadow-md transform scale-105">
                                <span class="text-[8px] font-bold text-teal-100 uppercase">IPVA 1% (Proposto)</span>
                                <div class="text-xl font-black text-white" id="ipvaProposed">R$ 1.000,00</div>
                            </div>
                        </div>
                        <div class="text-center mt-4 border-t border-slate-200 pt-3">
                            <span class="text-[9px] font-black text-teal-600 uppercase">Economia Direta / Ano</span>
                            <div class="text-2xl font-black text-teal-600" id="ipvaSavings">R$ 3.000,00</div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- SEÇÃO 2: PLANO DE VIABILIDADE (PDF + VÍDEO) -->
        <section id="plano" class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-black text-slate-900 uppercase">Plano de Viabilidade</h2>
                <div class="h-1 flex-grow bg-slate-200 mx-6"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Vídeo -->
                <div
                    class="card p-0 overflow-hidden bg-black aspect-video flex items-center justify-center rounded-2xl shadow-lg border border-slate-200">
                    <iframe class="w-full h-full" src="https://www.youtube.com/embed/vtjp3SWGuus?si=6ND8NGZ1JhvHXwB"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </div>

                <!-- PDF Embed -->
                <div
                    class="card p-0 overflow-hidden h-[400px] lg:h-auto rounded-2xl shadow-lg border border-slate-200 relative bg-slate-100 flex flex-col">
                    <div class="p-3 bg-white border-b border-slate-200 flex justify-between items-center">
                        <span class="text-[10px] uppercase font-black text-slate-500 flex items-center gap-2">
                            <i class="fa-solid fa-file-pdf text-red-500"></i> Documento Oficial
                        </span>
                        <a href="plano_viabilidade.pdf" target="_blank"
                            class="text-[10px] font-bold text-teal-600 hover:text-teal-500 uppercase tracking-wider flex items-center gap-1 transition">
                            <i class="fa-solid fa-expand"></i> Visualizar Completo
                        </a>
                    </div>
                    <div class="relative flex-grow">
                        <iframe src="plano_viabilidade.pdf" class="w-full h-full absolute inset-0"
                            style="border: none;">
                            <p class="text-center p-10 text-slate-500">Seu navegador não suporta a visualização de PDF.
                                <a href="plano_viabilidade.pdf" class="text-teal-600 font-bold hover:underline">Baixe o
                                    plano aqui.</a>
                            </p>
                        </iframe>
                    </div>
                </div>
            </div>
        </section>

        <!-- SEÇÃO 3: ASSEMBLEIA LEGISLATIVA (ALESP) -->
        <section id="deputados" class="card bg-slate-900 text-white relative overflow-hidden p-6 md:p-8">
            <div class="relative z-10">
                <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-black uppercase mb-2">Assembleia Legislativa</h2>
                        <p class="text-slate-400 text-sm max-w-lg leading-relaxed">
                            Pressione seu representante! Envie um e-mail cobrando o <strong>IPVA 1%</strong>.
                        </p>
                    </div>
                    <div class="w-full md:w-auto flex flex-col md:items-end gap-2">
                        <div class="relative">
                            <i
                                class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input type="text" id="deputadoSearch" placeholder="Buscar deputado ou partido..."
                                class="w-full md:w-64 bg-white/5 border border-white/10 rounded-lg pl-9 p-2.5 text-sm text-white outline-none focus:border-teal-500 transition placeholder-slate-600"
                                oninput="renderDeputados(this.value)">
                        </div>
                        <button onclick="selectAllDeputies()"
                            class="text-[10px] text-teal-400 font-bold hover:text-teal-300 transition uppercase tracking-wider">
                            <i class="fa-solid fa-check-double mr-1"></i> Selecionar Todos
                        </button>
                    </div>
                </div>

                <div id="deputadosGrid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <!-- Cards inseridos via JS -->
                </div>

                <div class="mt-4 text-center">
                    <a href="https://www.al.sp.gov.br/deputado/contato/" target="_blank"
                        class="text-[10px] text-slate-500 hover:text-teal-600 uppercase font-bold tracking-widest transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i> Conferir Lista Oficial ALESP
                    </a>
                </div>

                <!-- Barra Clustered Action Sticky -->
                <div id="bulkActionBar"
                    class="absolute bottom-0 left-0 right-0 bg-teal-900/95 backdrop-blur-md p-4 transform translate-y-full transition-transform duration-300 shadow-2xl border-t border-teal-500/30 flex justify-between items-center z-20">
                    <span class="text-white text-xs font-bold uppercase tracking-wide">
                        <span id="selectedCount" class="text-teal-400 text-lg mr-1 font-black">0</span> Selecionados
                    </span>
                    <button type="button" onclick="sendBulkEmail()"
                        class="bg-teal-500 hover:bg-teal-400 text-slate-900 px-6 py-3 rounded-lg font-black uppercase text-xs tracking-widest transition shadow-lg flex items-center">
                        <i class="fa-regular fa-paper-plane mr-2"></i> Enviar Cobrança em Massa
                    </button>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-20 py-10">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <div class="flex items-center justify-center mb-4">
                <i class="fa-solid fa-car-side text-teal-600 text-xl mr-2"></i>
                <span class="font-black text-lg text-slate-800 tracking-tighter uppercase">IPVA<span
                        class="text-teal-600">1%</span>SP</span>
            </div>
            <p class="text-xs text-slate-500 font-medium max-w-md mx-auto leading-relaxed">
                Este é um projeto independente de iniciativa popular. O objetivo é promover o debate sobre a redução da
                carga tributária e aumento da liberdade econômica no Estado de São Paulo.
            </p>
            <div
                class="mt-6 text-[10px] text-slate-400 font-bold uppercase tracking-widest flex flex-col gap-1 items-center">
                <span>&copy; 2027 IPVA 1% SP - Todos os direitos reservados.</span>
                <span class="opacity-60 text-[9px] lowercase font-normal">Atualizado: 20/01/2026 14:19</span>
            </div>
        </div>
    </footer>

    <script src="deputados.js"></script>
    <script>
        // Variável global para o gráfico
        let chartInstance = null;
        let isInternalUpdate = false;

        // --- FUNÇÕES AUXILIARES DE FORMATAÇÃO ---
        function parseCurrency(str) {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            let clean = str.toString().replace(/\D/g, "");
            return (parseFloat(clean) / 100) || 0;
        }

        function formatCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function parsePercentage(str) {
            if (!str) return 0;
            // Remove % and replace comma with dot
            let clean = str.toString().replace('%', '').replace(/\./g, '').replace(',', '.').trim();
            return parseFloat(clean) || 0;
        }

        // --- LÓGICA DE INPUT (Máscara + Cursor) ---
        function attachCurrencyMask(inputElement, callback) {
            inputElement.addEventListener('input', function (e) {
                if (isInternalUpdate) return;
                let start = this.selectionStart;
                let currentLen = this.value.length;
                let value = this.value.replace(/\D/g, "");
                let numberVal = (parseInt(value) / 100).toFixed(2);
                let formatted = "R$ " + numberVal.replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                if (isNaN(parseInt(value))) formatted = "R$ 0,00";

                this.value = formatted;

                // Cursor fix
                let newLen = this.value.length;
                let cursorOffset = newLen - currentLen;
                let newCursor = start + cursorOffset;
                if (newCursor < 3) newCursor = 3;
                this.setSelectionRange(newCursor, newCursor);

                if (callback) callback();
            });
            // Paste logic
            inputElement.addEventListener('paste', function (e) {
                e.preventDefault();
                let pasted = (e.clipboardData || window.clipboardData).getData('text');
                let clean = pasted.replace(/\D/g, "");
                document.execCommand("insertText", false, clean);
            });
        }

        const priceInput = document.getElementById('priceInput');
        const taxPercentInput = document.getElementById('taxPercentInput');
        const yearsInput = document.getElementById('yearsInput');

        // --- HANDLERS ---

        attachCurrencyMask(priceInput, updateCalculations);

        // Custom handler for percent
        if (taxPercentInput) {
            taxPercentInput.addEventListener('input', function (e) {
                // Allows digits and one comma
                let val = this.value.replace(/[^\d,]/g, '');
                // Avoid multiple commas
                const parts = val.split(',');
                if (parts.length > 2) {
                    val = parts[0] + ',' + parts.slice(1).join('');
                }

                this.value = val + "%";

                // Keep cursor before % if possible, or just end
                let pos = this.value.length - 1;
                this.setSelectionRange(pos, pos);

                updateCalculations();
            });
        }

        function adjustYears(delta) {
            let val = parseInt(yearsInput.value) || 5;
            val += delta;
            if (val < 1) val = 1;
            if (val > 30) val = 30;
            yearsInput.value = val;
            updateCalculations();
        }

        // --- CÁLCULOS CENTRAIS ---
        function updateCalculations() {
            const price = parseCurrency(priceInput.value);
            // Default tax if missing
            const taxRate = taxPercentInput ? parsePercentage(taxPercentInput.value) : 41.3;
            const years = yearsInput ? (parseInt(yearsInput.value) || 5) : 5;

            // 1. Tax Value calculation
            // Tax = Price * (Rate / 100)
            const taxValue = price * (taxRate / 100);

            // 2. Cost Real
            const cost = price - taxValue;

            // 3. Markup (Real)
            // Markup = (Imposto / Custo) * 100
            let markup = 0;
            if (cost > 0) {
                markup = (taxValue / cost) * 100;
            } else {
                markup = 0;
            }

            // 4. IPVA
            const ipvaCurrent = price * 0.04;
            const ipvaProposed = price * 0.01;
            const savings = ipvaCurrent - ipvaProposed;

            // 5. Totais (Longo Prazo)
            const totalTaxCurrent = taxValue + (ipvaCurrent * years);
            const totalTaxProposed = taxValue + (ipvaProposed * years);

            // --- ATUALIZAÇÃO DOM ---

            if (document.getElementById('taxValueDisplay'))
                document.getElementById('taxValueDisplay').textContent = formatCurrency(taxValue);

            if (document.getElementById('costAmount'))
                document.getElementById('costAmount').textContent = formatCurrency(cost);

            if (document.getElementById('markupPercent'))
                document.getElementById('markupPercent').textContent = markup.toFixed(2).replace('.', ',') + "%";

            // Col 3 (Simulação)
            if (document.getElementById('totalTaxCurrent'))
                document.getElementById('totalTaxCurrent').textContent = formatCurrency(totalTaxCurrent);

            if (document.getElementById('totalTaxProposed'))
                document.getElementById('totalTaxProposed').textContent = formatCurrency(totalTaxProposed);

            // Col 4 (Comparativo Anual)
            if (document.getElementById('ipvaCurrent'))
                document.getElementById('ipvaCurrent').textContent = formatCurrency(ipvaCurrent);

            if (document.getElementById('ipvaProposed'))
                document.getElementById('ipvaProposed').textContent = formatCurrency(ipvaProposed);

            if (document.getElementById('ipvaSavings'))
                document.getElementById('ipvaSavings').textContent = formatCurrency(savings);

            updateChart(cost, taxValue);
        }

        // --- GRÁFICO (Chart.js) ---
        function updateChart(cost, tax) {
            if (cost < 0) cost = 0;
            if (tax < 0) tax = 0;

            const ctx = document.getElementById('markupChart');
            if (!ctx) return;

            // Defaults
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = "'Inter', sans-serif";
                Chart.defaults.color = '#94a3b8';

                if (chartInstance) {
                    chartInstance.data.datasets[0].data = [cost, tax];
                    chartInstance.update();
                } else {
                    chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Custo Real', 'Impostos'],
                            datasets: [{
                                data: [cost, tax],
                                backgroundColor: ['#1e293b', '#dc2626'], // Slate-800 (Custo), Red-600 (Imposto)
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || '';
                                            if (label) label += ': ';
                                            label += formatCurrency(context.raw);
                                            return label;
                                        }
                                    }
                                }
                            },
                            cutout: '75%'
                        }
                    });
                }
            }
        }

        // --- INICIALIZAÇÃO ---
        window.addEventListener('load', function () {
            // Price Initialization
            if (priceInput && !priceInput.value) priceInput.value = "R$ 100.000,00";

            // Force clean state
            if (taxPercentInput && !taxPercentInput.value) taxPercentInput.value = "41,3%";

            updateCalculations();

            // Render deputados
            setTimeout(renderDeputados, 100);
        });

        // --- LÓGICA DE DEPUTADOS ---
        const selectedDeputies = new Set();
        const MAX_EMAIL_RECIPIENTS = 50;

        function renderDeputados() {
            const grid = document.getElementById('deputadosGrid');
            if (!grid) return;

            if (typeof deputados === 'undefined' || !Array.isArray(deputados)) {
                grid.innerHTML = '<div class="col-span-full text-center p-10 text-slate-500">Erro ao carregar dados dos deputados.</div>';
                return;
            }

            grid.innerHTML = '';

            const searchTerm = document.getElementById('deputadoSearch') ? document.getElementById('deputadoSearch').value.toLowerCase() : "";

            const filtered = deputados.filter(d =>
                d.name.toLowerCase().includes(searchTerm) ||
                d.party.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center p-10 text-slate-500">Nenhum deputado encontrado.</div>';
                return;
            }

            filtered.forEach((d, index) => {
                const isSelected = selectedDeputies.has(d.email);

                const mailSubject = encodeURIComponent("Apresentação de Projeto - IPVA 1% - Plano de Viabilidade");
                const mailBody = encodeURIComponent(`Excelentíssimo(a) Deputado(a) ${d.name},\n\nComo cidadão, solicito que analise e apoie o projeto do IPVA 1%.\n\nA proposta visa reduzir a carga tributária e trazer mais liberdade econômica para quem produz.\nConfira os detalhes e o plano de viabilidade técnica no site: http://ipva1sp.com.br\n\nContamos com seu apoio para dar validade e movimento a esta proposta.\n\nAtt,\nCidadão Paulista`);
                const mailLink = `mailto:${d.email}?subject=${mailSubject}&body=${mailBody}`;

                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border transition-all cursor-pointer relative group ${isSelected ? 'bg-teal-900/40 border-teal-500' : 'bg-white/5 border-white/10 hover:border-teal-500/50'}`;

                card.onclick = (e) => {
                    if (e.target.closest('a')) return;
                    toggleSelection(d.email, card);
                };

                // const actionHtml = `
                //     <div class="mt-auto pt-3 border-t border-white/10 flex gap-2">
                //         <a href="${mailLink}" class="flex-1 bg-teal-600 hover:bg-teal-500 text-white py-2 rounded-lg text-[10px] font-black uppercase tracking-wider flex items-center justify-center transition">
                //             Individual
                //         </a>
                //     </div>
                // `;

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-[9px] font-bold text-teal-400 uppercase tracking-wider">${d.party}</span>
                            <h3 class="font-bold text-white leading-tight">${d.name}</h3>
                        </div>
                        <div class="w-5 h-5 rounded-full border border-white/20 flex items-center justify-center ${isSelected ? 'bg-teal-500 border-teal-500' : ''}">
                             ${isSelected ? '<i class="fa-solid fa-check text-[10px] text-white"></i>' : ''}
                        </div>
                    </div>
                    <div class="space-y-1 text-xs text-slate-400 mb-3">
                        <div class="flex items-center"><i class="fa-solid fa-door-open w-5 opacity-50"></i> Gabinete ${d.room}</div>
                        <div class="flex items-center"><i class="fa-solid fa-phone w-5 opacity-50"></i> ${d.phone}</div>
                        <div class="flex items-center truncate" title="${d.email}"><i class="fa-solid fa-envelope w-5 opacity-50"></i> ${d.email}</div>
                    </div>
                    

                `;
                grid.appendChild(card);
            });

            grid.style.minHeight = "250px";
        }

        function toggleSelection(email, cardElement) {
            if (selectedDeputies.has(email)) {
                selectedDeputies.delete(email);
            } else {
                selectedDeputies.add(email);
            }
            renderDeputados();
            updateActionBar();
        }

        function toggleSelectAll() {
            const searchTerm = document.getElementById('deputadoSearch').value.toLowerCase();
            const visibleDeputies = deputados.filter(d =>
                d.name.toLowerCase().includes(searchTerm) ||
                d.party.toLowerCase().includes(searchTerm)
            );

            visibleDeputies.forEach(d => selectedDeputies.add(d.email));

            renderDeputados();
            updateActionBar();
        }

        function updateActionBar() {
            const count = selectedDeputies.size;
            const bar = document.getElementById('bulkActionBar');
            const countSpan = document.getElementById('selectedCount');

            if (countSpan) countSpan.textContent = count;

            if (bar) {
                if (count > 0) {
                    bar.classList.remove('translate-y-full');
                } else {
                    bar.classList.add('translate-y-full');
                }
            }
        }

        function sendBulkEmail(event) {
            if (event) event.preventDefault();
            const emails = Array.from(selectedDeputies);
            if (emails.length === 0) return;

            // Populate Modal
            const emailList = document.getElementById('emailListDisplay');
            const emailBody = document.getElementById('emailBodyDisplay');

            // Logic to split if too many? For now just all.
            emailList.value = emails.join(', ');

            const messageTemplate = `Prezados Deputados,

Como cidadão, solicito que analisem e apoiem o projeto do IPVA 1%.

A proposta visa reduzir a carga tributária e trazer mais liberdade econômica para quem produz.
Confira os detalhes e o plano de viabilidade técnica no site: http://ipva1sp.com.br

Contamos com seu apoio para dar validade e movimento a esta proposta.

Att,
Cidadão Paulista`;

            emailBody.value = messageTemplate;

            // Show Modal
            const modal = document.getElementById('emailInstructionModal');
            modal.classList.remove('hidden');
        }

        function closeEmailModal() {
            document.getElementById('emailInstructionModal').classList.add('hidden');
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            el.setSelectionRange(0, 99999); // Mobile
            navigator.clipboard.writeText(el.value).then(() => {
                // Visual Feedback could be added here
                // alert("Copiado!");
            });
        }

        // Listener Busca
        if (document.getElementById('deputadoSearch')) {
            document.getElementById('deputadoSearch').addEventListener('input', () => {
                renderDeputados();
            });
        }
    </script>
</body>


<!-- Modal de Instrução de Email -->
<div id="emailInstructionModal" class="fixed inset-0 z-[100] hidden">
    <!-- Backdrop Blur -->
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeEmailModal()">
    </div>

    <!-- Modal Content -->
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-6 md:p-8 transform transition-all scale-100">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-2xl font-black text-slate-900 uppercase">Mobilização Manual</h2>
                <p class="text-sm text-slate-500 mt-1">
                    Para garantir mais <strong>visibilidade e validação</strong>, o envio deve ser feito da <strong>sua
                        própria caixa de e-mail</strong>.
                    <br><br>
                    Realizamos este trabalho para facilitar o processo, mas o envio não pode ser automatizado. É o seu
                    envio manual que dá movimento e autenticidade à proposta.
                </p>
            </div>
            <button onclick="closeEmailModal()" class="text-slate-400 hover:text-red-500 transition text-xl p-2"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="space-y-6">
            <!-- Passo 1 -->
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-black text-teal-600 uppercase tracking-widest">1. Copie os
                        Destinatários</span>
                    <button onclick="copyToClipboard('emailListDisplay')"
                        class="text-[10px] bg-white border border-slate-200 hover:border-teal-500 text-slate-600 hover:text-teal-600 px-3 py-1 rounded-lg font-bold uppercase transition flex items-center gap-2">
                        <i class="fa-regular fa-copy"></i> Copiar Lista
                    </button>
                </div>
                <textarea id="emailListDisplay" readonly
                    class="w-full h-24 bg-white border border-slate-200 rounded-lg p-3 text-xs text-slate-600 font-mono resize-none focus:outline-none focus:border-teal-500 transition"></textarea>
                <p class="text-[9px] text-slate-400 mt-2 text-right">Cole no campo <strong>"Para"</strong> ou
                    <strong>"BCC"</strong> do seu e-mail.
                </p>
            </div>

            <!-- Passo 2 -->
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-black text-teal-600 uppercase tracking-widest">2. Copie a
                        Mensagem</span>
                    <button onclick="copyToClipboard('emailBodyDisplay')"
                        class="text-[10px] bg-white border border-slate-200 hover:border-teal-500 text-slate-600 hover:text-teal-600 px-3 py-1 rounded-lg font-bold uppercase transition flex items-center gap-2">
                        <i class="fa-regular fa-copy"></i> Copiar Texto
                    </button>
                </div>
                <div class="relative">
                    <textarea id="emailBodyDisplay" readonly
                        class="w-full h-32 bg-white border border-slate-200 rounded-lg p-3 text-xs text-slate-600 resize-none focus:outline-none focus:border-teal-500 transition"></textarea>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end gap-3">
            <button onclick="closeEmailModal()"
                class="px-6 py-2.5 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 transition uppercase tracking-wide">
                Cancelar
            </button>
            <!-- <a href="mailto:?subject=Apresentação%20de%20Projeto%20-%20IPVA%201%25%20-%20Plano%20de%20Viabilidade"
                target="_blank"
                class="px-6 py-2.5 rounded-xl bg-teal-600 hover:bg-teal-500 text-white text-xs font-black uppercase tracking-wide shadow-lg shadow-teal-500/30 transition flex items-center gap-2">
                <i class="fa-solid fa-paper-plane"></i> Abrir Meu E-mail
            </a> -->
        </div>
    </div>
</div>
</body>

</html>